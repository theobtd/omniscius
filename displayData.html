<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment Map</title>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        
        .info-container {
            height: 80%; /* Same height as map */
            width: 40%; /* Adjust width as needed */
            margin: 5vh 0; /* Center vertically and add bottom margin */
            border: 2px solid #3f5787;
            background-color: white;
            position: fixed; /* Fixed position on the right */
            right: 5%; /* Align to the right */
            padding: 20px; /* Add some padding */
            box-sizing: border-box; /* Include padding in height/width calculations */
            overflow-y: auto; /* Scroll if content overflows */
        }
        
        #mapContainer {
            height: 80%;
            width: 40%;
            margin: 5vh 0; /* Center vertically and add bottom margin */
            border: 2px solid #3f5787;
            background-color: white;
            position: fixed; /* Fixed position on the right */
            left: 5%; /* Align to the left */
            padding: 20px; /* Add some padding */
            box-sizing: border-box; /* Include padding in height/width calculations */
        }
        
        svg {
            width: 100%; /* Take full width of the container */
            height: 100%; /* Adjust height based on width */
        }
        
        .region {
            stroke: #3f5787;
            stroke-width: 2.708;
        }
        
        /* Loading overlay styles */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Ensure it stays above other content */
        }
        
        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite; /* Animation */
        }

        .title {
            text-align: center; /* Center the text */
            margin: 20px 0; /* Add some vertical spacing */
            font-size: 2em; /* Adjust font size as needed */
            color: #3f5787; /* Change color to match your theme */
        }

        .button-container {
            display: flex; /* Use flexbox for row layout */
            justify-content: center; /* Center buttons horizontally */
            margin: 20px 0; /* Add some vertical spacing */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .risk-title {
            margin: 0; /* Adjust this value as needed */
        }
        
        /* Media queries for responsive design */
        @media (max-width: 768px) { /* Adjust this value for mobile breakpoints */
            #mapContainer,
            .info-container {
                position: relative; /* Change to relative to stack them */
                width: 90%; /* Full width for mobile */
                margin: 5vh auto; /* Center with vertical margin and auto for left/right margins */
                max-width: 600px; /* Optional: set a max width to prevent too wide on large phones */
            }
        
            #mapContainer {
                height: auto; /* Allow height to adjust */
            }
        }
    </style>
</head>
<body>

    <h1 class="title">AgSafe.Farm</h1>
    
    <div class="map-container" id="mapContainer">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loader"></div>
        </div>
        <div class="button-container">
            <h2 class="risk-title">Risque Tomates</h2>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1354 1354">
            <path class="region" id="Occitanie" fill="white" d="M778.860009,1121.936328l2.952464-82.668992l106.288704-50.191888l45.763197-73.811601-25.095948-26.572178-231.768428-94.478842h-54.620579L454.088965,1068.791975l324.771044,53.144353Z" />
            <path class="region" id="Centre_Val_de_Loire" fill="white" d="M761.145225,563.920628l.000002-177.147841-129.908419-85.621458-53.144353,22.143481-8.857392,63.477976-67.906674,126.955953l103.33624,97.431312l91.526385,8.857392l64.954211-56.096815Z" />
            <path class="region" id="Hauts_de_France" fill="white" d="M715.382032,23.619712L861.529006,162.38552L799.527257,301.151329L761.145226,271.62669L648.951598,259.816834l-.000001-88.57392-26.572177-20.667248L648.951592,44.286959l66.43044-20.667247Z" />
            <path class="region" id="Bretagne" fill="white" d="M99.793284,323.294811L235.606629,286.38901l23.619712,28.048407l115.146097,8.857392l35.429568,19.191014l2.952463,64.954208L291.703444,466.48931L105.698211,386.772782l26.572176-29.524639-32.477103-33.953332Z" />
            <path class="region" id="PACA" fill="white" d="M888.101177,989.075448l171.242914,50.191887L1180.395116,932.97863l14.762325-44.286961h-59.049286l-5.904928-59.04928-44.28696-38.382032-90.050147,59.04928l13.286082,38.382032h-100.383775l25.095952,26.572178-45.763202,73.811601Z" />
            <path class="region" id="Ile_de_France" fill="white" d="M648.951592,259.816834L761.145225,271.62669l38.382031,29.52464-2.952464,56.096817-35.429568,29.524639-129.908417-85.621457q23.619714-38.38203,17.714785-41.334495Z" />
            <path class="region" id="Auvergne_Rhone_Alpes" fill="white" d="M908.768426,885.739206L677,794.212822l19.191016-174.195378l64.954209-56.096813l85.621456,82.668991l188.957699-26.57218l56.096815-8.857393l38.382031,121.051024-44.28696,59.04928-90.050147,59.049279l13.286082,38.382032-100.383775-2.952458Z" />   
            <path class="region" id="Normandie" fill="white" d="M622.379416,150.575665l26.572177,20.667248-.000001,88.573922-17.714786,41.334495-53.144354,22.14348-8.857392,63.477975-159.433058-44.286961-35.429568-19.191015-29.524641-140.242042l50.191888,2.952464l17.714784,41.334497l88.573921,8.857392l121.05103-85.621455Z" />
            <path class="region" id="Pays_de_la_Loire" fill="white" d="M374.372439,622.969908l62.00175-11.809856-23.61972-67.906672l88.57392-29.52464l67.906674-126.955952-159.433058-44.286962l2.952463,64.95421-121.051025,59.049279l82.668996,156.480593Z" />
            <path class="region" id="Nouvelle_Aquitaine" fill="white" d="M327.133014,989.075447l47.239427-366.105539l62.001742-11.809856-23.619714-67.906673l88.573919-29.52464l103.336235,97.431312l91.526389,8.857392-19.191016,174.195378-54.62058-2.952464L454.08896,1068.791975L327.133014,989.075447Z" />
            <path class="region" id="Bourgogne_Franche_Comte" fill="white" d="M1035.72438,620.017439l70.859138-153.528124-138.765808-8.857393L796.574793,357.248147l-35.429565,29.524639v177.14784l85.621452,82.668992l188.9577-26.572179Z" />
            <path class="region" id="Grand_Est" fill="white" d="M1195.157436,268.674227L861.529002,162.385521L799.527258,301.15133l-2.952465,56.096818L967.817705,457.631923l138.765808,8.857392l44.286959-14.76232l44.286964-183.052768Z" />
        </svg>
    </div>

    <div class="info-container" id="infoContainer">
        <h2>Region Information</h2>
        <div id="loadingInfo" class="loading-overlay" style="display: none;">
            <div class="loader"></div>
        </div>
        <div id="infoMessage">Tuta Absoluta: À SELECTIONNER<br>Botrytis: À SELECTIONNER<br>Puceron Cendré: À SELECTIONNER<br>Punaise Nesidiocoris: À SELECTIONNER</div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_7hMxk4IPshKVrAGFC4OpqNj9uFFQp5Y",
            authDomain: "omniscius-7bf29.firebaseapp.com",
            databaseURL: "https://omniscius-7bf29-default-rtdb.firebaseio.com",
            projectId: "omniscius-7bf29",
            storageBucket: "omniscius-7bf29",
            messagingSenderId: "24281922885",
            appId: "1:24281922885:web:5d417050ef79e22e6b522c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const regionCoordinates = [
            "Occitanie",
            "Centre Val de Loire",
            "Hauts de France",
            "Bretagne",
            "PACA",
            "Ile de France",
            "Auvergne Rhone Alpes",
            "Normandie",
            "Pays de la Loire",
            "Nouvelle Aquitaine",
            "Bourgogne Franche Comte",
            "Grand Est"
        ];

        const regionOrder = [
            "Auvergne Rhone Alpes",
            "Bourgogne Franche Comte",
            "Bretagne",
            "Centre Val de Loire",
            "Grand Est",
            "Hauts de France",
            "Ile de France",
            "Normandie",
            "Nouvelle Aquitaine",
            "Occitanie",
            "PACA",
            "Pays de la Loire"
        ];

        async function fetchRiskLevels() {
            try {
                const overallRiskList = await database.ref('OverallRiskList').once('value').then(snapshot => snapshot.val());
                const riskLevelsArray = overallRiskList.split(','); // Convert the string to an array
        
                // Create an object to store region names and their corresponding risk levels
                const results = {};
                riskLevelsArray.forEach(entry => {
                    const [regionName, riskLevel] = entry.split('='); // Split each entry into region and risk
                    results[regionName.trim()] = riskLevel.trim(); // Store in the results object
                });
        
                return results; // Return the object
            } catch (error) {
                console.error('Error fetching overall risk levels:', error);
                return regionOrder.reduce((acc, region) => {
                    acc[region] = "unknown"; // Return "unknown" for all regions if there's an error
                    return acc;
                }, {});
            }
        }

        function getColor(overallRisk) {
            if (overallRisk === "High") return 'red';
            if (overallRisk === "Medium") return 'yellow';
            return 'green';
        }

        async function fetchRiskLevelsForRegion(regionName) {
            try {
                const tutaRisk = await database.ref(`TutaAbsoluta/${regionName}`).once('value').then(snapshot => snapshot.val());
                const botrytisRisk = await database.ref(`Botrytis/${regionName}`).once('value').then(snapshot => snapshot.val());
                const puceroncendreRisk = await database.ref(`PuceronCendre/${regionName}`).once('value').then(snapshot => snapshot.val());
                const punaisenesidiocorisRisk = await database.ref(`PunaiseNesidiocoris/${regionName}`).once('value').then(snapshot => snapshot.val());
                
                return { tutaRisk, botrytisRisk, puceroncendreRisk, punaisenesidiocorisRisk };
            } catch (error) {
                console.error(`Error fetching risk levels for ${regionName}:`, error);
                return { tutaRisk: "unknown", botrytisRisk: "unknown", puceroncendreRisk: "unknown", punaisenesidiocorisRisk: "unknown" };
            }
        }

        async function setRegionColors() {
            const riskLevels = await fetchRiskLevels(); // Get the object of risk levels
            const regions = document.querySelectorAll('.region');
            
            // Set initial title
            const titleElement = document.querySelector('#infoContainer h2');
            titleElement.textContent = "Select a region";
            
            regions.forEach(region => {
                const regionName = region.id.replace(/_/g, ' '); // Replace underscores with spaces for matching names
                const riskData = riskLevels[regionName]; // Get the risk level using the region name
            
                if (riskData) {
                    const color = getColor(riskData);
                    region.setAttribute('fill', color);
                }
            
                region.addEventListener('click', async () => {
                    // Show loader
                    document.getElementById('loadingInfo').style.display = 'flex';
            
                    const { tutaRisk, botrytisRisk, puceroncendreRisk, punaisenesidiocorisRisk } = await fetchRiskLevelsForRegion(regionName);
            
                    // Hide loader
                    document.getElementById('loadingInfo').style.display = 'none';
            
                    const infoMessage = `
                        Tuta Absoluta Risk: ${tutaRisk}<br>
                        Botrytis Risk: ${botrytisRisk}<br>
                        Puceron Cendré Risk: ${puceroncendreRisk}<br>
                        Punaise Nesidiocoris Risk: ${punaisenesidiocorisRisk}
                    `;
                    document.getElementById('infoMessage').innerHTML = infoMessage; // Update info div
            
                    // Update the title to the selected region
                    titleElement.textContent = regionName;
                });
            });
        
            document.getElementById('loadingOverlay').style.display = 'none'; // Hide loader
        }

        // Button selection handling
        const buttons = document.querySelectorAll('.map-button');
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove selected class from all buttons
                buttons.forEach(btn => btn.classList.remove('selected'));
                // Add selected class to the clicked button
                button.classList.add('selected');
            });
        });

        document.addEventListener('DOMContentLoaded', setRegionColors);
    </script>
</body>
</html>
